

# Avoidance pie charts: overall, per site, and per date × site
suppressPackageStartupMessages({
  library(tidyverse)
  library(svglite)
  library(scales)
})

# ==== CONFIG ====
out_dir <- "/Users/benjaminhailstone/Documents/GitHub/rumble-strips/data/Avoidance Pie Charts"
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

# Validate `cb`
if (!exists("cb")) {
  stop("Object `cb` not found. Make sure `cb <- tar_read(camera_back_data)` has been run and is in the environment.")
}
req_cols <- c("class", "site", "date")
missing <- setdiff(req_cols, names(cb))
if (length(missing) > 0) {
  stop("Missing required columns in `cb`: ", paste(missing, collapse = ", "))
}

# Detect avoidance column
candidate_cols <- names(cb)
detect_avoid_col <- function(df, cols) {
  for (nm in cols) {
    vals <- tolower(as.character(df[[nm]]))
    has_avoided <- any(grepl("^\\s*avoided\\s*$", vals))
    has_not_avoided <- any(grepl("^\\s*not\\s+avoided\\s*$", vals))
    if (has_avoided || has_not_avoided) return(nm)
  }
  NA_character_
}
avoid_col <- detect_avoid_col(cb, candidate_cols)
if (is.na(avoid_col)) {
  stop("Could not auto-detect the avoidance column in `cb`. Expected values include 'avoided' and 'not avoided' (case-insensitive).")
}

# Normalize and filter to expected values
valid_sites <- c("sr12", "us6", "i70", "us191")

format_date_vec <- function(x) {
  # Return YYYY-MM-DD strings wherever possible
  if (inherits(x, "Date")) {
    format(x, "%Y-%m-%d")
  } else if (inherits(x, "POSIXct") || inherits(x, "POSIXt")) {
    format(as.Date(x), "%Y-%m-%d")
  } else {
    # try parsing, otherwise return as character
    dx <- suppressWarnings(as.Date(x))
    ifelse(!is.na(dx), format(dx, "%Y-%m-%d"), as.character(x))
  }
}

cb_clean <- cb %>%
  mutate(
    class     = tolower(.data[["class"]]),
    site      = tolower(as.character(.data[["site"]])),
    avoidance = tolower(as.character(.data[[avoid_col]])),
    date_str  = format_date_vec(.data[["date"]])
  ) %>%
  filter(
    class %in% c("passenger", "motercycle", "truck"),
    avoidance %in% c("avoided", "not avoided"),
    site %in% valid_sites
  )

# Pie palette and levels
grp_levels <- c(
  "passenger / avoided", "passenger / not avoided",
  "motercycle / avoided", "motercycle / not avoided",
  "truck / avoided",     "truck / not avoided"
)
pal <- c(
  "passenger / avoided"     = "#2C7FB8", # blue
  "passenger / not avoided" = "#A6BDDB", # light blue
  "motercycle / avoided"    = "#41AB5D", # green
  "motercycle / not avoided"= "#A1D99B", # light green
  "truck / avoided"         = "#D7301F", # red
  "truck / not avoided"     = "#FCBBA1"  # light red
)

# Helper: build and save a 6-slice pie for a given subset

make_pie <- function(
  df_sub, title, subtitle, caption, outfile,
  label_inside_threshold = 0.06,     # slices < 6% get outside labels
  edge_gap = 0.02,                   # small gap beyond the pie edge for the leader start
  leader_len = 0.10,                 # length of the leader line (radial)
  label_r_extra = 0.15               # how far beyond the pie edge the label sits
) {
  if (nrow(df_sub) == 0) {
    message("Skipping (no data): ", outfile)
    return(invisible(NULL))
  }

  # Summarize and compute geometry for labels
  df <- df_sub %>%
    count(class, avoidance, name = "n") %>%
    mutate(
      total = sum(n),
      perc  = n / total,
      grp   = paste(class, avoidance, sep = " / ")
    ) %>%
    mutate(grp = factor(grp, levels = grp_levels)) %>%
    arrange(grp) %>%
    # mid-position of each slice in "y" units (used by coord_polar for angle)
    mutate(
      ypos      = cumsum(n) - n / 2,
      label_txt = scales::percent(perc, accuracy = 0.1),
      is_small  = perc < label_inside_threshold
    ) %>%
    # Convert mid-position to an angle (radians) for side-aware alignment
    mutate(
      angle_rad = 2 * pi * (ypos / total),        # 0..2π, 0 at top
      on_right  = cos(angle_rad) >= 0,            # right half of circle?
      hjust_out = ifelse(on_right, 0, 1),         # left-align on right, right-align on left
      # radial positions (x in coord_polar) for line and label, measured from pie edge ~ 1.00
      r_line_start = 1.00 + edge_gap,             # just outside the perimeter
      r_line_end   = 1.00 + edge_gap + leader_len,# line tip further out
      r_label      = 1.00 + edge_gap + leader_len + label_r_extra
    )

  if (sum(df$n) == 0) {
    message("Skipping (zero counts): ", outfile)
    return(invisible(NULL))
  }

  p <- ggplot(df, aes(x = "", y = n, fill = grp)) +
    geom_col(width = 1, color = "white") +
    coord_polar(theta = "y", clip = "off") +  # keep outside labels visible
    scale_fill_manual(values = pal, name = "Class / Avoidance", drop = FALSE) +

    # Inside labels for sufficiently large slices (unchanged geometry)
    geom_text(
      data = df %>% dplyr::filter(!is_small),
      aes(label = label_txt),
      position = position_stack(vjust = 0.5),
      size = 3.8,
      color = "black",
      fontface = "bold",
      na.rm = TRUE
    ) +

    # Leader lines for small slices: radial segments from the pie edge outward
    geom_segment(
      data = df %>% dplyr::filter(is_small),
      aes(x = r_line_start, xend = r_line_end, y = ypos, yend = ypos),
      color = "grey30",
      size = 0.4,
      inherit.aes = FALSE,
      na.rm = TRUE
    ) +

    # Outside percentage labels for small slices (placed well outside the circle)
    geom_text(
      data = df %>% dplyr::filter(is_small),
      aes(x = r_label, y = ypos, label = label_txt, hjust = hjust_out),
      size = 3.8,
      color = "black",
      fontface = "bold",
      inherit.aes = FALSE,
      na.rm = TRUE
    ) +

    labs(title = title, subtitle = subtitle, caption = caption) +
    theme_void(base_size = 12) +
    theme(
      plot.title       = element_text(face = "bold"),
      legend.position  = "right",
      panel.background = element_rect(fill = "white", color = NA),
      plot.background  = element_rect(fill = "white", color = NA)
    )

  # White-background SVG export
  ggplot2::ggsave(
    outfile, plot = p, device = svglite::svglite,
    width = 8, height = 6, bg = "white"
  )
  message("Saved: ", outfile)
}


# ==== 1) Overall (entire tibble) ====
overall_caption <- paste0("Source: cb | Avoidance column: `", avoid_col, "`")
overall_file <- file.path(out_dir, "avoidance_by_class_pie__overall.svg")
make_pie(
  df_sub   = cb_clean,
  title    = "Avoidance Status by Vehicle Class",
  subtitle = "Overall (single pie with six slices)",
  caption  = overall_caption,
  outfile  = overall_file
)

# ==== 2) Per site ====
for (s in sort(unique(cb_clean$site))) {
  site_df <- cb_clean %>% filter(site == s)
  site_file <- file.path(out_dir, paste0("avoidance_by_class_pie__site_", s, ".svg"))
  make_pie(
    df_sub   = site_df,
    title    = "Avoidance Status by Vehicle Class",
    subtitle = paste0("Site: ", toupper(s)),
    caption  = overall_caption,
    outfile  = site_file
  )
}

# ==== 3) Per date × site ====
# Iterate each site, then each date observed within that site
for (s in sort(unique(cb_clean$site))) {
  site_dates <- cb_clean %>%
    filter(site == s) %>%
    distinct(date_str) %>%
    pull(date_str)

  for (d in sort(site_dates)) {
    df_sd <- cb_clean %>% filter(site == s, date_str == d)
    safe_d <- gsub("[^0-9A-Za-z_-]", "_", d) # sanitize for filename
    out_file <- file.path(
      out_dir,
      paste0("avoidance_by_class_pie__date_", safe_d, "__site_", s, ".svg")
    )
    make_pie(
      df_sub   = df_sd,
      title    = "Avoidance Status by Vehicle Class",
      subtitle = paste0("Date: ", d, " | Site: ", toupper(s)),
      caption  = overall_caption,
      outfile  = out_file
    )
  }
}
